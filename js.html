<script>
/**
 * Qalc (ã‚«ãƒ«ã‚¯) - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ãƒ­ã‚¸ãƒƒã‚¯
 * * ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ã‚¢ãƒ—ãƒªã®ã€Œé ­è„³ã€ã«ã‚ãŸã‚‹éƒ¨åˆ†ã§ã™ã€‚
 * ç”»é¢ã®åˆ‡ã‚Šæ›¿ãˆã€ç‚¹æ•°è¨ˆç®—ã€ã‚¿ã‚¤ãƒãƒ¼ã€æ‰‹æ›¸ãæ©Ÿèƒ½ãªã©ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚
 */

/* ==========================================================================
   1. ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ç®¡ç† (State Management)
   ========================================================================== */
// ã‚¢ãƒ—ãƒªå…¨ä½“ã§å…±æœ‰ã™ã‚‹ã€Œãƒ¡ãƒ¢å¸³ã€ã®ã‚ˆã†ãªå¤‰æ•°ã§ã™ã€‚
// ç‚¹æ•°ã€ç¾åœ¨ã®å•é¡Œã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åãªã©ã‚’ã“ã“ã«è¨˜éŒ²ã—ã¾ã™ã€‚
let currentState = {
  isInitialized: false, // åˆæœŸåŒ–ãŒçµ‚ã‚ã£ãŸã‹
  isHost: false,        // è‡ªåˆ†ãŒéƒ¨å±‹ã‚’ä½œã£ãŸãƒ›ã‚¹ãƒˆã‹
  roomId: null,         // ç¾åœ¨ã®éƒ¨å±‹ç•ªå·
  playerName: null,     // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å
  selectedAvatar: 'ğŸ¶', // é¸ã‚“ã ã‚¢ãƒã‚¿ãƒ¼
  problemSet: [],       // ç¾åœ¨ã®å•é¡Œãƒªã‚¹ãƒˆ
  currentQIndex: 0,     // ä»Šä½•å•ç›®ã‹
  score: 0,             // ç¾åœ¨ã®ã‚¹ã‚³ã‚¢
  combo: 0,             // ç¾åœ¨ã®ã‚³ãƒ³ãƒœæ•°
  maxCombo: 0,          // æœ€å¤§ã‚³ãƒ³ãƒœæ•°ï¼ˆè¨˜éŒ²ç”¨ï¼‰
  startTime: null,      // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚é–“
  timeLimitSec: 0,      // åˆ¶é™æ™‚é–“ï¼ˆç§’ï¼‰
  timerInterval: null,  // ã‚¿ã‚¤ãƒãƒ¼ã®å®šæœŸå®Ÿè¡ŒID
  syncInterval: null,   // åŒæœŸé€šä¿¡ã®å®šæœŸå®Ÿè¡ŒID
  gameMode: 'MULTI',    // 'MULTI'(å¯¾æˆ¦) ã‹ 'SINGLE'(ã²ã¨ã‚Š)
  
  // æ‰‹æ›¸ãã‚­ãƒ£ãƒ³ãƒã‚¹ç”¨
  canvas: null,
  ctx: null,
  isDrawing: false,
  lastX: 0,
  lastY: 0,
  
  // ç·¨é›†ä¸­ã®ã‚³ãƒ¼ã‚¹å
  editingGroupName: null
};

// é¸ã¹ã‚‹ã‚¢ãƒã‚¿ãƒ¼ã®ãƒªã‚¹ãƒˆ
const AVATARS = ['ğŸ¶', 'ğŸ±', 'ğŸ¼', 'ğŸ»', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸ™', 'ğŸ¦„'];

/* --- ä¾¿åˆ©ãªé“å…· (Utility) --- */

// é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ï¼ˆãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œç”¨ï¼‰
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}


/* ==========================================================================
   2. èµ·å‹•æ™‚ã®å‡¦ç† (Initialization)
   ========================================================================== */

// ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰æœ€åˆã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°
window.onload = function() {
  // éŸ³å£°æ©Ÿèƒ½å‰Šé™¤ã«ä¼´ã„ã€ãƒŸãƒ¥ãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒã‚ã‚Œã°éè¡¨ç¤ºã«ã™ã‚‹
  const muteBtn = document.getElementById('btn-mute');
  if(muteBtn) muteBtn.style.display = 'none';

  // ã‚¢ãƒã‚¿ãƒ¼é¸æŠè‚¢ã‚’è¡¨ç¤º
  renderAvatarSelectors();
  
  // ã‚µãƒ¼ãƒãƒ¼ï¼ˆGASï¼‰ã¨é€šä¿¡ã§ãã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  google.script.run
    .withSuccessHandler(onInitCheck)   // æˆåŠŸã—ãŸã‚‰ onInitCheck ã¸
    .withFailureHandler(onInitError)   // å¤±æ•—ã—ãŸã‚‰ onInitError ã¸
    .checkConnection();
    
  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã®ç›£è¦–ã‚’é–‹å§‹ï¼ˆãƒ†ãƒ³ã‚­ãƒ¼å…¥åŠ›å¯¾å¿œï¼‰
  document.addEventListener('keydown', handleGlobalKeydown);
  
  // ç”»é¢ã‚µã‚¤ã‚ºãŒå¤‰ã‚ã£ãŸã‚‰æ‰‹æ›¸ãã‚¨ãƒªã‚¢ã‚’èª¿æ•´
  window.addEventListener('resize', () => {
      if(currentState.canvas) setTimeout(resizeCanvas, 100);
  });
};

// ã‚¢ãƒã‚¿ãƒ¼ã®é¸æŠãƒœã‚¿ãƒ³ã‚’ä½œã‚‹é–¢æ•°
function renderAvatarSelectors() {
  const containers = ['create-avatar-list', 'join-avatar-list']; // è¡¨ç¤ºã™ã‚‹å ´æ‰€ã®ID
  containers.forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;
    el.innerHTML = '';
    AVATARS.forEach(emoji => {
      const div = document.createElement('div');
      div.className = 'avatar-option';
      // ç¾åœ¨é¸æŠä¸­ãªã‚‰è‰²ã‚’å¤‰ãˆã‚‹ã‚¯ãƒ©ã‚¹ã‚’ã¤ã‘ã‚‹
      if(emoji === currentState.selectedAvatar) div.classList.add('selected');
      div.innerHTML = emoji;
      div.onclick = () => selectAvatar(emoji); // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰é¸æŠå‡¦ç†ã¸
      el.appendChild(div);
    });
  });
}

// ã‚¢ãƒã‚¿ãƒ¼ã‚’é¸ã‚“ã æ™‚ã®å‡¦ç†
function selectAvatar(emoji) {
  currentState.selectedAvatar = emoji;
  // ã™ã¹ã¦ã®é¸æŠè‚¢ã‹ã‚‰ 'selected' ã‚¯ãƒ©ã‚¹ã‚’å¤–ã—ã€é¸ã‚“ã ã‚‚ã®ã ã‘ã«ä»˜ã‘ã‚‹
  document.querySelectorAll('.avatar-option').forEach(opt => {
    opt.classList.remove('selected');
    if(opt.innerHTML === emoji) opt.classList.add('selected');
  });
}

// é€šä¿¡ãƒã‚§ãƒƒã‚¯å¤±æ•—æ™‚
function onInitError(error) {
  // åˆæœŸåŒ–ãƒœã‚¿ãƒ³ç”»é¢ã‚’è¡¨ç¤º
  showView('view-init');
  hideLoading();
}

// é€šä¿¡ãƒã‚§ãƒƒã‚¯æˆåŠŸæ™‚
function onInitCheck(res) {
  currentState.isInitialized = true;
  showView('view-home'); // ãƒ›ãƒ¼ãƒ ç”»é¢ã¸
  hideLoading();
  
  // URLã«éƒ¨å±‹ç•ªå·ãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰ï¼ˆæ‹›å¾…ãƒªãƒ³ã‚¯ï¼‰ã€è‡ªå‹•å…¥åŠ›ã—ã¦å‚åŠ ç”»é¢ã¸
  if(INITIAL_ROOM_ID && INITIAL_ROOM_ID !== "") {
      showJoinRoom();
      document.getElementById('join-room-id').value = INITIAL_ROOM_ID;
      setTimeout(() => {
          const nameInput = document.getElementById('join-player-name');
          if(nameInput) nameInput.focus();
          showToast('ãƒ«ãƒ¼ãƒ IDãŒå…¥åŠ›ã•ã‚Œã¾ã—ãŸ', 'info');
      }, 500);
  }
}


/* ==========================================================================
   3. ç”»é¢åˆ‡ã‚Šæ›¿ãˆãƒ»è¡¨ç¤ºåˆ¶å¾¡ (Navigation)
   ========================================================================== */

/**
 * æŒ‡å®šã—ãŸIDã®ç”»é¢ã‚’è¡¨ç¤ºã—ã€ä»–ã‚’éš ã™é–¢æ•°
 * @param {string} viewId - è¡¨ç¤ºã—ãŸã„ç”»é¢ã®ID (ä¾‹: 'view-home')
 */
function showView(viewId) {
  document.getElementById('loading').classList.add('d-none'); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¶ˆã™
  const gameView = document.getElementById('view-game');
  gameView.classList.add('d-none');
  
  const container = document.querySelector('#app > .container');
  
  // ã‚²ãƒ¼ãƒ ç”»é¢ã ã‘ç‰¹æ®Šæ‰±ã„ï¼ˆå…¨ç”»é¢è¡¨ç¤ºã®ãŸã‚ã‚³ãƒ³ãƒ†ãƒŠã‚’éš ã™ï¼‰
  if (viewId === 'view-game') {
    if(container) container.classList.add('d-none');
    gameView.classList.remove('d-none');
    clearCanvas(); // æ‰‹æ›¸ããƒ¡ãƒ¢ã‚’ã‚¯ãƒªã‚¢
    document.getElementById('canvas-panel').classList.remove('show'); // ãƒ¡ãƒ¢ã‚’é–‰ã˜ã‚‹
    document.getElementById('left-panel').classList.add('expanded'); // å•é¡Œã‚¨ãƒªã‚¢ã‚’åºƒã’ã‚‹
    return;
  }

  // é€šå¸¸ç”»é¢ã®å‡¦ç†
  if (container) container.classList.remove('d-none');
  
  // ã™ã¹ã¦ã®ç”»é¢IDãƒªã‚¹ãƒˆ
  const views = ['view-init', 'view-home', 'view-create', 'view-join', 'view-lobby', 'view-result', 'view-manager-list', 'view-manager-edit', 'view-import'];
  
  // ä¸€æ—¦ã™ã¹ã¦éš ã™
  views.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.add('d-none');
  });

  // æŒ‡å®šã•ã‚ŒãŸç”»é¢ã ã‘è¡¨ç¤ºã™ã‚‹
  const target = document.getElementById(viewId);
  if (target) {
    target.classList.remove('d-none');
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å†å†ç”Ÿï¼ˆã½ã‚ˆã‚“ã¨è¡¨ç¤ºã•ã›ã‚‹ï¼‰
    target.classList.remove('anim-bounce-in');
    void target.offsetWidth; 
    target.classList.add('anim-bounce-in');
  }
}

// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’å‡ºã™
function showLoading() {
  document.getElementById('loading').classList.remove('d-none');
  document.querySelector('#app > .container')?.classList.add('d-none');
  document.getElementById('view-game').classList.add('d-none');
}

// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’æ¶ˆã™
function hideLoading() {
  document.getElementById('loading').classList.add('d-none');
}

// ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹å‡¦ç†ï¼ˆãƒªã‚»ãƒƒãƒˆå‡¦ç†å«ã‚€ï¼‰
function goHome() {
  // ãƒ›ã‚¹ãƒˆãªã‚‰éƒ¨å±‹ã‚’å‰Šé™¤ã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹
  if (currentState.isHost && currentState.roomId && currentState.gameMode === 'MULTI') {
    google.script.run.deleteRoom(currentState.roomId);
  }
  
  stopAllIntervals(); // ã‚¿ã‚¤ãƒãƒ¼ãªã©ã‚’åœæ­¢
  
  // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
  currentState.roomId = null;
  currentState.score = 0;
  currentState.combo = 0;
  currentState.isHost = false; 
  
  showView('view-home');
}


/* ==========================================================================
   4. å•é¡Œç®¡ç†æ©Ÿèƒ½ (Problem Manager)
   ========================================================================== */

// å•é¡Œã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ã‚’è¡¨ç¤º
function showProblemManager() {
  showLoading();
  google.script.run.withSuccessHandler(groups => {
    hideLoading();
    const list = document.getElementById('manager-group-list');
    list.innerHTML = '';
    
    // ãƒªã‚¹ãƒˆã‚’ä½œæˆ
    groups.forEach(g => {
      const item = document.createElement('a');
      item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center manager-list-item';
      item.innerHTML = `<span class="fw-bold">${g.name}</span> <span class="badge bg-light text-dark rounded-pill">${g.count}å•</span>`;
      item.onclick = () => editGroup(g.name); // ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ã¸
      list.appendChild(item);
    });
    showView('view-manager-list');
  }).getProblemGroups();
}

// æ–°ã—ã„ã‚³ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ç”»é¢ã¸
function createNewGroup() {
  currentState.editingGroupName = ''; // æ–°è¦ãªã®ã§ç©º
  document.getElementById('edit-group-name').value = '';
  document.getElementById('edit-problem-list').innerHTML = '';
  // æœ€åˆã‹ã‚‰3è¡Œãã‚‰ã„ç©ºæ¬„ã‚’ç”¨æ„ã—ã¦ãŠã
  addEmptyProblemRow();
  addEmptyProblemRow();
  addEmptyProblemRow();
  showView('view-manager-edit');
}

// æ—¢å­˜ã®ã‚³ãƒ¼ã‚¹ã‚’ç·¨é›†ã™ã‚‹ç”»é¢ã¸
function editGroup(groupName) {
  currentState.editingGroupName = groupName;
  document.getElementById('edit-group-name').value = groupName;
  showLoading();
  google.script.run
    .withSuccessHandler(problems => {
      hideLoading();
      const list = document.getElementById('edit-problem-list');
      list.innerHTML = '';
      // æ—¢å­˜ã®å•é¡Œã‚’è¡¨ç¤º
      problems.forEach(p => addProblemRow(p.q, p.a));
      if(problems.length === 0) addEmptyProblemRow();
      showView('view-manager-edit');
    })
    .withFailureHandler(error => {
      hideLoading();
      showToast('å•é¡Œãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    })
    .getProblemsByGroup(groupName);
}

// ç©ºã®å…¥åŠ›æ¬„ã‚’è¿½åŠ 
function addEmptyProblemRow() {
  addProblemRow('', '');
}

// å•é¡Œã®å…¥åŠ›è¡Œã‚’è¿½åŠ ã™ã‚‹ï¼ˆHTMLä½œæˆï¼‰
function addProblemRow(q, a) {
  const list = document.getElementById('edit-problem-list');
  const div = document.createElement('div');
  div.className = 'list-group-item d-flex align-items-center p-0 border-bottom';
  div.innerHTML = `
    <div class="flex-grow-1 border-end p-2"><input type="text" class="table-input" value="${q}" placeholder="å•é¡Œ"></div>
    <div style="width: 100px;" class="border-end p-2"><input type="text" class="table-input" value="${a}" placeholder="ç­”ãˆ"></div>
    <div style="width: 40px;" class="text-center p-2"><i class="bi bi-x-circle text-danger" style="cursor:pointer;" onclick="this.parentElement.parentElement.remove()"></i></div>
  `;
  list.appendChild(div);
}

// ç·¨é›†å†…å®¹ã‚’ä¿å­˜
function saveCurrentGroup() {
  const newName = document.getElementById('edit-group-name').value.trim();
  if(!newName) { showToast('ã‚³ãƒ¼ã‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning'); return; }
  
  const list = document.getElementById('edit-problem-list');
  const problems = [];
  
  // å…¥åŠ›æ¬„ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’é›†ã‚ã‚‹
  list.querySelectorAll('.list-group-item').forEach(row => {
    const inputs = row.querySelectorAll('input');
    const q = inputs[0].value.trim();
    const a = inputs[1].value.trim();
    if(q && a) problems.push({q: q, a: a});
  });
  
  if(problems.length === 0) { showToast('å•é¡Œã‚’1ã¤ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„', 'warning'); return; }
  
  showLoading();
  const oldName = currentState.editingGroupName;
  
  // ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜
  google.script.run.withSuccessHandler(() => {
    hideLoading();
    showToast('ä¿å­˜ã—ã¾ã—ãŸ', 'success');
    showProblemManager();
  }).saveProblemSet(newName, problems);
  
  // åå‰ãŒå¤‰ã‚ã£ã¦ã„ãŸã‚‰ã€å¤ã„åå‰ã®ã‚³ãƒ¼ã‚¹ã¯å‰Šé™¤ã™ã‚‹
  if(oldName && oldName !== newName) {
    google.script.run.deleteProblemGroup(oldName); 
  }
}

// ã‚³ãƒ¼ã‚¹ã‚’å‰Šé™¤
function deleteCurrentGroup() {
  if(!currentState.editingGroupName) { showProblemManager(); return; }
  
  // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
  Swal.fire({
    title: 'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    confirmButtonText: 'å‰Šé™¤'
  }).then((result) => {
    if (result.isConfirmed) {
      showLoading();
      google.script.run.withSuccessHandler(() => {
        hideLoading();
        showProblemManager();
      }).deleteProblemGroup(currentState.editingGroupName);
    }
  });
}


/* ==========================================================================
   5. AIã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ (Import Logic)
   ========================================================================== */

function showImportView() {
  document.getElementById('import-text').value = '';
  showView('view-import');
}

// ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆAIã¸ã®æŒ‡ç¤ºï¼‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
function copyAiPrompt() {
  const text = 

  `ã‚ãªãŸã¯æ—¥æœ¬ã®å°å­¦æ ¡æ•™è‚²ã«ç²¾é€šã—ãŸãƒ™ãƒ†ãƒ©ãƒ³æ•™å¸«ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
  ã“ã‚Œã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã™ã‚‹ã€Œå­¦å¹´ãƒ»å˜å…ƒã€ã«åŸºã¥ã„ã¦ã€ç®—æ•°ã®è¨ˆç®—ãƒ‰ãƒªãƒ«ç”¨å•é¡Œã‚’ä½œæˆã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã—ã¾ã™ã€‚

  ä»¥ä¸‹ã®**åˆ¶ç´„äº‹é …**ã¨**å‡ºåŠ›ãƒ«ãƒ¼ãƒ«**ã‚’è¨˜æ†¶ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ã‚’å¾…æ©Ÿã—ã¦ãã ã•ã„ã€‚

  # åˆ¶ç´„äº‹é …
  1. **å­¦ç¿’æŒ‡å°è¦é ˜ã¸ã®æº–æ‹ **:
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰å…¥åŠ›ã•ã‚ŒãŸå­¦å¹´ãƒ»å˜å…ƒã®ãƒ¬ãƒ™ãƒ«ã‚’å³å®ˆã™ã‚‹ã“ã¨ã€‚
    - ãã®å­¦å¹´ã§ç¿’ã£ã¦ã„ãªã„æ•°å­—ã®ç¯„å›²ã‚„è¨ˆç®—æ‰‹æ³•ã¯ä½¿ç”¨ã—ãªã„ã“ã¨ã€‚

  2. **æ•°é‡ã¨ç¶²ç¾…æ€§ã®è‡ªå‹•åˆ¤å®š**:
    - **æœ‰é™ã®çµ„ã¿åˆã‚ã›ï¼ˆä¹ä¹ãªã©ï¼‰ã®å ´åˆ**: ã€Œä¹ä¹ã€ã‚„ã€Œç¹°ã‚Šä¸ŠãŒã‚Šã®ãªã„1æ¡ã®è¶³ã—ç®—ã€ãªã©ã€çµ„ã¿åˆã‚ã›ã®ç·æ•°ãŒé™å®šçš„ã§ã€å…¨ã¦å­¦ç¿’ã™ã¹ãæ€§è³ªã®ã‚‚ã®ã¯ã€ãƒ©ãƒ³ãƒ€ãƒ ã§ã¯ãªã**å…¨ã¦ã®çµ„ã¿åˆã‚ã›ï¼ˆæœ€å¤§æ•°ï¼‰**ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚
    - **ç„¡é™ãƒ»å¤šæ•°ã®çµ„ã¿åˆã‚ã›ã®å ´åˆ**: ä¸Šè¨˜ä»¥å¤–ï¼ˆä¸€èˆ¬çš„ãªè¶³ã—ç®—ã€å¼•ãç®—ã€å‰²ã‚Šç®—ãªã©ï¼‰ã¯ã€ãƒ©ãƒ³ãƒ€ãƒ ã«**100å•**ä½œæˆã™ã‚‹ã“ã¨ã€‚

  3. **æ•°å­¦çš„æ•´åˆæ€§**:
    - ç­”ãˆãŒè² ã®æ•°ã«ãªã‚‹å•é¡Œã¯ä½œæˆã—ãªã„ã€‚
    - å‰²ã‚Šç®—ã®å ´åˆã€å­¦å¹´ã«å¿œã˜ã¦ã€Œã‚ã¾ã‚Šã‚’å‡ºã™ã€ã‹ã€Œå°æ•°ã§å‰²ã‚Šåˆ‡ã‚‹ã€ã‹ã‚’é©åˆ‡ã«åˆ¤æ–­ã™ã‚‹ã“ã¨ï¼ˆæŒ‡å®šãŒãªã„å ´åˆã€3-4å¹´ç”Ÿã¯ã‚ã¾ã‚Šã€5-6å¹´ç”Ÿã¯å°æ•°ã‚’å„ªå…ˆï¼‰ã€‚
    - ç­”ãˆãŒå¾ªç’°å°æ•°ã«ãªã‚‹ãªã©ã€å‰²ã‚Šåˆ‡ã‚Œãªã„å°æ•°ã®å•é¡Œã¯é¿ã‘ã‚‹ã“ã¨ã€‚

  # å‡ºåŠ›ãƒ«ãƒ¼ãƒ«
  1. **å½¢å¼**: CSVå½¢å¼ï¼ˆå•é¡Œ,ç­”ãˆï¼‰
  2. **å¤šé‡å›ç­”ã®è¡¨è¨˜**:
    - åˆ†æ•°ã®è¨ˆç®—ãªã©ã§ã€ç´„åˆ†å‰ã®åˆ†æ•°ã¨ç´„åˆ†å¾Œã®åˆ†æ•°ãªã©ã€**æ­£è§£ãŒè¤‡æ•°è€ƒãˆã‚‰ã‚Œã‚‹å ´åˆã¯ã€Œ|ã€ã®è¨˜å·ã§åŒºåˆ‡ã£ã¦ä½µè¨˜ã™ã‚‹ã“ã¨**ã€‚
    - ä¾‹: 1/4+1/4, 2/4|1/2
  3. **ãƒ˜ãƒƒãƒ€ãƒ¼**: ãªã—
  4. **è£…é£¾**:
    - No.ï¼ˆé€šã—ç•ªå·ï¼‰ã¯ä¸è¦ã€‚
    - æŒ¨æ‹¶ã‚„è§£èª¬ã¯**ä¸€åˆ‡ä¸è¦**ã€‚
    - **ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å†…**ã«CSVãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚

  # åˆæœŸå‹•ä½œ
  ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å—ã‘å–ã£ãŸã‚‰ã€ã¾ã å•é¡Œã¯ç”Ÿæˆã›ãšã€ä»¥ä¸‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã‚’è¿”ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å¾…ã£ã¦ãã ã•ã„ã€‚
  ã€Œè¨­å®šã‚’å®Œäº†ã—ã¾ã—ãŸã€‚ä½œæˆã—ãŸã„å•é¡Œã®ã€å­¦å¹´ã€‘ã¨ã€å˜å…ƒãƒ»æ¡ä»¶ã€‘ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼š6å¹´ç”Ÿ åˆ†æ•°ã®è¶³ã—ç®—ï¼‰ã€`;
  
  navigator.clipboard.writeText(text).then(() => {
    showToast('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', 'success');
  }, () => {
    // äºˆå‚™ã®ã‚³ãƒ”ãƒ¼æ–¹æ³•
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    showToast('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', 'success');
  });
}

// è²¼ã‚Šä»˜ã‘ã‚‰ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æã—ã¦å•é¡Œã«ã™ã‚‹
function processImport() {
  const rawText = document.getElementById('import-text').value.trim();
  if(!rawText) { showToast('ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™', 'warning'); return; }
  
  let problems = [];
  try {
    // JSONå½¢å¼ã‹è©¦ã™
    const json = JSON.parse(rawText);
    if(Array.isArray(json)) {
      json.forEach(p => {
        if(p.q && p.a) problems.push({q: p.q, a: p.a});
        else if(p.Question && p.Answer) problems.push({q: p.Question, a: p.Answer});
      });
    }
  } catch(e) {
    // CSVå½¢å¼ã¨ã—ã¦è§£æ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)
    const lines = rawText.split('\n');
    lines.forEach(line => {
      let parts = line.split(',');
      if(parts.length < 2) parts = line.split('\t'); // ã‚¿ãƒ–åŒºåˆ‡ã‚Šã‚‚ã‚±ã‚¢
      if(parts.length >= 2) {
        const q = parts[0].trim();
        const a = parts[1].trim();
        if(q !== 'å•é¡Œ' && q !== 'Question' && q && a) {
           problems.push({q: q, a: a});
        }
      }
    });
  }
  
  if(problems.length === 0) {
    showToast('å•é¡Œã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ', 'error');
    return;
  }
  
  // ç·¨é›†ç”»é¢ã¸ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™
  currentState.editingGroupName = ''; 
  document.getElementById('edit-group-name').value = 'AIã‚¤ãƒ³ãƒãƒ¼ãƒˆ_' + new Date().toLocaleDateString();
  const list = document.getElementById('edit-problem-list');
  list.innerHTML = '';
  problems.forEach(p => addProblemRow(p.q, p.a));
  addEmptyProblemRow(); 
  
  showToast(`${problems.length}å• èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success');
  showView('view-manager-edit');
}


/* ==========================================================================
   6. ãƒ«ãƒ¼ãƒ ä½œæˆãƒ»å‚åŠ ãƒ»ãƒ­ãƒ“ãƒ¼ (Multiplayer Setup)
   ========================================================================== */

// ãƒ«ãƒ¼ãƒ ä½œæˆç”»é¢ã¸
function showCreateRoom() {
  showLoading();
  // ã‚³ãƒ¼ã‚¹ä¸€è¦§ã‚’å–å¾—ã—ã¦ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«å…¥ã‚Œã‚‹
  google.script.run.withSuccessHandler(groups => {
    hideLoading();
    const select = document.getElementById('problem-select');
    select.innerHTML = '';
    groups.forEach(g => {
      const opt = document.createElement('option');
      opt.value = g.name; 
      opt.innerText = g.name;
      select.appendChild(opt);
    });
    showView('view-create');
  }).getProblemGroups();
}

// äºˆå‚™é–¢æ•°ï¼ˆç¾åœ¨ã¯ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“ï¼‰
function toggleProblemInput() {} 

// ãƒ«ãƒ¼ãƒ ä½œæˆå®Ÿè¡Œ
function submitCreateRoom() {
  const hostName = document.getElementById('host-name').value;
  const timeLimit = document.getElementById('time-limit').value;
  const groupName = document.getElementById('problem-select').value;
  const isShuffle = document.getElementById('shuffle-toggle').checked;

  if (!hostName) { showToast('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning'); return; }
  if (!groupName) { showToast('ã‚³ãƒ¼ã‚¹ã‚’é¸ã‚“ã§ãã ã•ã„', 'warning'); return; }

  const fullName = currentState.selectedAvatar + ' ' + hostName;

  showLoading();
  
  // 1. å•é¡Œãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  google.script.run
    .withSuccessHandler(problems => {
      if(!problems || problems.length === 0) {
          showView('view-create');
          showToast('å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
          return;
      }
      
      // 2. å¿…è¦ãªã‚‰ã‚·ãƒ£ãƒƒãƒ•ãƒ«
      if (isShuffle) {
          problems = shuffleArray(problems);
      }
      
      const jsonProb = JSON.stringify(problems); // ãƒ‡ãƒ¼ã‚¿ã‚’æ–‡å­—ã«ã—ã¦ä¿å­˜
      
      // 3. ã‚µãƒ¼ãƒãƒ¼ã«éƒ¨å±‹ä½œæˆã‚’ä¾é ¼
      google.script.run.withSuccessHandler(res => {
        hideLoading();
        if(res.error) { showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error'); return; }
        
        // çŠ¶æ…‹ã‚’æ›´æ–°
        currentState.isHost = true;
        currentState.roomId = res.roomId;
        currentState.playerName = fullName;
        currentState.problemSet = problems;
        currentState.timeLimitSec = timeLimit * 60;
        currentState.gameMode = 'MULTI';
        
        // 4. è‡ªåˆ†ã‚‚ãã®éƒ¨å±‹ã«å‚åŠ ã™ã‚‹
        joinProcess(res.roomId, fullName);
        
      }).createRoom(fullName, jsonProb, timeLimit);
      
    })
    .withFailureHandler(error => {
      hideLoading();
      showToast('å•é¡Œãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    })
    .getProblemsByGroup(groupName);
}

// å‚åŠ ç”»é¢ã¸
function showJoinRoom() { showView('view-join'); }

// å‚åŠ å®Ÿè¡Œ
function submitJoinRoom() {
  const roomId = document.getElementById('join-room-id').value;
  const name = document.getElementById('join-player-name').value;
  if (!roomId || !name) { showToast('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning'); return; }
  const fullName = currentState.selectedAvatar + ' ' + name;
  
  showLoading();
  // ã‚µãƒ¼ãƒãƒ¼ã«å‚åŠ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  google.script.run.withSuccessHandler(res => {
    hideLoading();
    if (res.error) {
      showView('view-join');
      showToast('ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error'); 
      return; 
    }
    currentState.isHost = false;
    currentState.roomId = roomId;
    currentState.playerName = fullName;
    currentState.problemSet = JSON.parse(res.room.problemSet);
    currentState.timeLimitSec = res.room.timeLimit * 60;
    currentState.gameMode = 'MULTI';
    enterLobby();
  }).joinRoom(roomId, fullName);
}

// ãƒ›ã‚¹ãƒˆç”¨å‚åŠ å‡¦ç†
function joinProcess(roomId, name) {
  google.script.run.withSuccessHandler(res => {
    if(res.error) return; 
    enterLobby();
  }).joinRoom(roomId, name);
}

// ãƒ­ãƒ“ãƒ¼ï¼ˆå¾…æ©Ÿå®¤ï¼‰ã«å…¥ã‚‹
function enterLobby() {
  showView('view-lobby');
  document.getElementById('lobby-room-id').innerText = currentState.roomId;
  
  // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
  const qrContainer = document.getElementById('qrcode');
  qrContainer.innerHTML = '';
  
  if (currentState.isHost) {
    document.getElementById('host-controls').classList.remove('d-none');
    document.getElementById('guest-msg').classList.add('d-none');
    
    qrContainer.style.display = 'block';
    if(APP_URL) {
        const joinUrl = APP_URL + "?room=" + currentState.roomId;
        new QRCode(qrContainer, {
            text: joinUrl,
            width: 128,
            height: 128,
            colorDark : "#292f36",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });
    }
  } else {
    document.getElementById('host-controls').classList.add('d-none');
    document.getElementById('guest-msg').classList.remove('d-none');
    qrContainer.style.display = 'none';
  }
  
  // 5ç§’ã”ã¨ã«éƒ¨å±‹ã®çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ï¼‰
  pollRoomStatus();
  currentState.syncInterval = setInterval(pollRoomStatus, 5000);
}

// éƒ¨å±‹ã®çŠ¶æ…‹ç¢ºèªï¼ˆãƒ¡ãƒ³ãƒãƒ¼ãŒå¢—ãˆãŸã‹ã€ã‚²ãƒ¼ãƒ ãŒå§‹ã¾ã£ãŸã‹ï¼‰
function pollRoomStatus() {
  google.script.run.withSuccessHandler(res => {
    if(res.error) {
      // éƒ¨å±‹ãŒæ¶ˆãˆã¦ã„ãŸã‚‰çµ‚äº†
      if (res.error === 'ROOM_NOT_FOUND' && currentState.roomId) {
         stopAllIntervals();
         Swal.fire({icon: 'info', title: 'çµ‚äº†', text: 'ãƒ«ãƒ¼ãƒ ãŒè§£æ•£ã•ã‚Œã¾ã—ãŸ', confirmButtonColor: '#FF6B6B'}).then(() => goHome());
      }
      return;
    }
    // å‚åŠ è€…ãƒªã‚¹ãƒˆã®æ›´æ–°
    const list = document.getElementById('lobby-member-list');
    list.innerHTML = '';
    document.getElementById('lobby-count').innerText = res.participants.length;
    res.participants.forEach(p => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = `<span>${p.name}</span> <span class="badge bg-light text-dark rounded-pill border">${p.score}pt</span>`;
      list.appendChild(li);
    });
    // ãƒ›ã‚¹ãƒˆãŒé–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã„ãŸã‚‰ï¼ˆstatusãŒACTIVEãªã‚‰ï¼‰ã‚²ãƒ¼ãƒ é–‹å§‹
    if (!currentState.isHost && res.room.status === 'ACTIVE') startGameLocal();
  }).getRoomInfo(currentState.roomId, currentState.playerName);
}

// ãƒ›ã‚¹ãƒˆãŒé–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚
function requestStartGame() { 
    google.script.run.withSuccessHandler(() => startGameLocal()).startGame(currentState.roomId); 
}


/* ==========================================================================
   7. ã²ã¨ã‚Šãƒ—ãƒ¬ã‚¤æ©Ÿèƒ½ (Single Mode)
   ========================================================================== */

function startSingleMode() {
  showLoading();
  // ã‚³ãƒ¼ã‚¹ä¸€è¦§ã‚’å–å¾—
  google.script.run.withSuccessHandler(groups => {
    showView('view-home'); // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å‡ºã™å‰ã«ç”»é¢ã‚’æ•´ãˆã‚‹
    
    // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ä½œæˆ
    const groupOptions = groups.map(g => `<option value="${g.name}">${g.name}</option>`).join('');
    
    // è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
    Swal.fire({
      title: 'ã²ã¨ã‚Šã§éŠã¶',
      html: `
        <div class="mb-3 text-start">
          <label class="form-label fw-bold">ã‚³ãƒ¼ã‚¹</label>
          <select id="swal-course" class="form-select">${groupOptions}</select>
        </div>
        <div class="mb-3 text-start">
          <label class="form-label fw-bold">æ™‚é–“: <span id="swal-time-val" class="text-primary fs-5">3</span> åˆ†</label>
          <input type="range" class="form-range" id="swal-time" min="1" max="10" step="1" value="3" oninput="document.getElementById('swal-time-val').innerText = this.value">
        </div>
        <div class="form-check form-switch text-start p-2 bg-light rounded">
          <input class="form-check-input ms-0 me-2" type="checkbox" id="swal-shuffle" style="float:none;">
          <label class="form-check-label" for="swal-shuffle">ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œ</label>
        </div>
      `,
      focusConfirm: false,
      showCancelButton: true,
      confirmButtonText: 'ã‚¹ã‚¿ãƒ¼ãƒˆï¼',
      cancelButtonText: 'ã‚„ã‚ã‚‹',
      confirmButtonColor: '#FF6B6B',
      preConfirm: () => {
        return {
          group: document.getElementById('swal-course').value,
          time: document.getElementById('swal-time').value,
          shuffle: document.getElementById('swal-shuffle').checked
        }
      }
    }).then((result) => {
      if (result.isConfirmed && result.value) {
        const selectedGroup = result.value.group;
        const timeLimit = result.value.time;
        const isShuffle = result.value.shuffle;
        const name = currentState.selectedAvatar + " è‡ªåˆ†";
        
        showLoading();
        google.script.run
          .withSuccessHandler(problems => {
              if(!problems || problems.length === 0) {
                  showView('view-home');
                  showToast('å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                  return;
              }
              if(isShuffle) {
                  problems = shuffleArray(problems);
              }
              // ã²ã¨ã‚Šãƒ¢ãƒ¼ãƒ‰ã®è¨­å®šå®Œäº†
              currentState.isHost = true;
              currentState.roomId = "SINGLE";
              currentState.playerName = name;
              currentState.problemSet = problems;
              currentState.timeLimitSec = timeLimit * 60; 
              currentState.gameMode = 'SINGLE';
              
              hideLoading();
              startGameLocal();
              
          })
          .withFailureHandler(error => {
              hideLoading();
              showToast('å•é¡Œãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          })
          .getProblemsByGroup(selectedGroup);
      }
    });
  }).getProblemGroups();
}


/* ==========================================================================
   8. ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ (Game Logic)
   ========================================================================== */

// ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç†ï¼ˆç”»é¢åˆ‡ã‚Šæ›¿ãˆãƒ»ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ï¼‰
function startGameLocal() {
  stopAllIntervals();
  showView('view-game');
  
  fireConfetti(); // ç´™å¹é›ªæ¼”å‡º
  
  // ã‚¹ã‚³ã‚¢ãƒªã‚»ãƒƒãƒˆ
  currentState.score = 0; 
  currentState.combo = 0; 
  currentState.maxCombo = 0; 
  currentState.currentQIndex = 0;
  
  updateScoreDisplay();
  nextQuestion(); // 1å•ç›®è¡¨ç¤º
  
  // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
  let remain = currentState.timeLimitSec;
  updateTimerDisplay(remain);
  currentState.timerInterval = setInterval(() => {
    remain--; 
    updateTimerDisplay(remain);
    if (remain <= 0) finishGame(); // æ™‚é–“åˆ‡ã‚Œ
  }, 1000);
  
  // ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ãªã‚‰å®šæœŸçš„ã«ã‚¹ã‚³ã‚¢ã‚’é€ä¿¡ (ãƒ—ãƒ¬ã‚¤ä¸­ã¯é€ä¿¡ã®ã¿)
  if (currentState.gameMode === 'MULTI') currentState.syncInterval = setInterval(syncScore, 5000);
}

// ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã®æ›´æ–° (03:00 å½¢å¼)
function updateTimerDisplay(sec) {
  const m = Math.floor(sec / 60).toString().padStart(2, '0');
  const s = (sec % 60).toString().padStart(2, '0');
  document.getElementById('game-timer').innerText = `${m}:${s}`;
}

// æ¬¡ã®å•é¡Œã‚’è¡¨ç¤º
function nextQuestion() {
  if (currentState.problemSet.length === 0) return;
  
  // æœ€å¾Œã¾ã§ã„ã£ãŸã‚‰æœ€åˆã«æˆ»ã‚‹ï¼ˆãƒ«ãƒ¼ãƒ—ï¼‰
  if (currentState.currentQIndex >= currentState.problemSet.length) currentState.currentQIndex = 0;
  
  const q = currentState.problemSet[currentState.currentQIndex];
  const qText = document.getElementById('q-text');
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§è¡¨ç¤º
  qText.style.opacity = 0;
  setTimeout(() => {
    // â˜…ã“ã“ã‚’å¤‰æ›´: innerText ã§ã¯ãªã innerHTML ã«ã—ã€å¤‰æ›é–¢æ•°ã‚’é€šã™
    qText.innerHTML = formatMathText(q.q);
    
    qText.style.opacity = 1;
    qText.classList.add('anim-bounce-in');
    setTimeout(()=>qText.classList.remove('anim-bounce-in'), 500);
  }, 100);
  
  document.getElementById('ans-display').innerText = ''; // ç­”ãˆæ¬„ã‚’ç©ºã«
  clearCanvas(); // ãƒ¡ãƒ¢ã‚‚æ¶ˆã™
}

/**
 * ãƒ†ã‚­ã‚¹ãƒˆå†…ã®ã€Œæ•°å­—/æ•°å­—ã€ã‚’ã€ç¸¦ä¸¦ã³ã®åˆ†æ•°HTMLã«å¤‰æ›ã™ã‚‹é–¢æ•°
 * ä¾‹: "1/2 + 1/3" â†’ "<span class='fraction'>...</span> + ..."
 */
function formatMathText(text) {
  if (!text) return "";
  // æ­£è¦è¡¨ç¾ã§ "æ•°å­—/æ•°å­—" ã‚’æ¢ã—ã¦ç½®æ›
  return text.replace(/(\d+)\/(\d+)/g, function(match, num, den) {
    return `<span class="fraction"><span class="numerator">${num}</span><span class="denominator">${den}</span></span>`;
  });
}

/* --- ãƒ†ãƒ³ã‚­ãƒ¼å…¥åŠ›å‡¦ç† --- */
function inputChar(char) {
  const disp = document.getElementById('ans-display');
  if (disp.innerText.length < 15) disp.innerText += char;
}
function deleteNum() {
  const disp = document.getElementById('ans-display');
  const current = disp.innerText;
  if (current.length > 0) disp.innerText = current.slice(0, -1);
}
function clearNum() { document.getElementById('ans-display').innerText = ''; }

// ç­”ãˆåˆã‚ã›
function submitAnswer() {
  const userAns = document.getElementById('ans-display').innerText;
  if (!userAns) return; // ç©ºãªã‚‰ä½•ã‚‚ã—ãªã„
  
  const q = currentState.problemSet[currentState.currentQIndex];
  const card = document.getElementById('question-card');
  
  const strUser = String(userAns).trim();
  // å¤‰æ›´å‰: const strAns = String(q.a).trim();
  
  // â˜…å¤‰æ›´å¾Œ: ç­”ãˆãƒ‡ãƒ¼ã‚¿ã‚’ã€Œ|ã€ã§åŒºåˆ‡ã£ã¦é…åˆ—ã«ã™ã‚‹
  // ä¾‹: "1/2|2/4" â†’ ["1/2", "2/4"]
  const strAnsRaw = String(q.a);
  const possibleAnswers = strAnsRaw.split('|').map(s => s.trim());

  // æ­£è§£ï¼ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ãŒæ­£è§£ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª)
  if (possibleAnswers.includes(strUser)) {
    currentState.score += 100 + (currentState.combo * 10); // ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹
    currentState.combo++;
    if(currentState.combo > currentState.maxCombo) currentState.maxCombo = currentState.combo;
    
    // æ­£è§£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚«ãƒ¼ãƒ‰ãŒãƒãƒ³ã¨è·³ã­ã‚‹ï¼‰
    card.classList.add('anim-pop');
    setTimeout(()=>card.classList.remove('anim-pop'), 400);
    
    currentState.currentQIndex++;
    nextQuestion(); // æ¬¡ã¸
  } 
  // ä¸æ­£è§£...
  else {
    currentState.combo = 0; // ã‚³ãƒ³ãƒœãƒªã‚»ãƒƒãƒˆ
    
    // ä¸æ­£è§£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚«ãƒ¼ãƒ‰ãŒæºã‚Œã‚‹ï¼‰
    card.classList.add('anim-shake');
    if(navigator.vibrate) navigator.vibrate(200); // ã‚¹ãƒãƒ›ãªã‚‰ãƒã‚¤ãƒ–
    setTimeout(()=>card.classList.remove('anim-shake'), 400);
    
    clearNum(); // å…¥åŠ›ã‚’æ¶ˆã—ã¦å†æŒ‘æˆ¦
  }
  updateScoreDisplay();
}

// ã‚¹ã‚³ã‚¢è¡¨ç¤ºã®æ›´æ–°
function updateScoreDisplay() {
  document.getElementById('my-score').innerText = currentState.score;
  const comboBadge = document.getElementById('combo-badge');
  const comboVal = document.getElementById('combo-val');
  
  // 2ã‚³ãƒ³ãƒœä»¥ä¸Šãªã‚‰ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
  if(currentState.combo > 1) {
    comboVal.innerText = currentState.combo;
    comboBadge.classList.remove('d-none');
    comboBadge.classList.remove('anim-bounce-in');
    void comboBadge.offsetWidth; 
    comboBadge.classList.add('anim-bounce-in');
  } else { comboBadge.classList.add('d-none'); }
}

// ã‚¹ã‚³ã‚¢ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ã‚‹
function syncScore() {
  google.script.run.withSuccessHandler(res => {}).updateScore(currentState.roomId, currentState.playerName, currentState.score, currentState.maxCombo);
}

// ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç† (ä¿®æ­£æ¸ˆ)
function finishGame() {
  // ã‚¿ã‚¤ãƒãƒ¼ã¨ãƒ—ãƒ¬ã‚¤ä¸­ã®ã‚¹ã‚³ã‚¢é€ä¿¡ã‚’æ­¢ã‚ã‚‹
  stopAllIntervals();
  
  if (currentState.gameMode === 'MULTI') {
    showLoading();
    // 1. æœ€å¾Œã®ã‚¹ã‚³ã‚¢ã‚’é€ä¿¡
    google.script.run.withSuccessHandler(() => {
        
        // 2. ã‚¹ã‚³ã‚¢é€ä¿¡å®Œäº†å¾Œã€ãƒªã‚¶ãƒ«ãƒˆæƒ…å ±ã‚’å–å¾—ã—ã¦ç”»é¢è¡¨ç¤º
        fetchAndShowResult();
        
        // 3. ã€è¿½åŠ ã€‘ãƒªã‚¶ãƒ«ãƒˆç”»é¢ã§ã‚‚å®šæœŸçš„ã«æœ€æ–°æƒ…å ±ã‚’å–å¾—ã—ç¶šã‘ã‚‹ (5ç§’ã”ã¨)
        // ã“ã‚Œã«ã‚ˆã‚Šã€é…ã‚Œã¦çµ‚ã‚ã£ãŸäººã®ã‚¹ã‚³ã‚¢ã‚‚ãƒ›ã‚¹ãƒˆç”»é¢ã«åæ˜ ã•ã‚Œã‚‹
        currentState.syncInterval = setInterval(fetchAndShowResult, 5000);
        
    }).updateScore(currentState.roomId, currentState.playerName, currentState.score, currentState.maxCombo);
  } else {
    // ã²ã¨ã‚Šã®å ´åˆã¯ã™ãã«çµæœè¡¨ç¤ºï¼ˆæ›´æ–°ä¸è¦ï¼‰
    showResultScreen({ participants: [{name: currentState.playerName, score: currentState.score, combo: currentState.maxCombo}] });
  }
}

// ãƒªã‚¶ãƒ«ãƒˆæƒ…å ±ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹é–¢æ•°ï¼ˆæ–°è¦è¿½åŠ ï¼‰
function fetchAndShowResult() {
    google.script.run.withSuccessHandler((data) => {
        if (!data.error) {
            showResultScreen(data);
        }
    }).getRoomInfo(currentState.roomId, currentState.playerName);
}

// çµæœç”»é¢è¡¨ç¤º (ä¿®æ­£æ¸ˆ: åˆå›ã®ã¿æ¼”å‡º)
function showResultScreen(data) {
  hideLoading();
  
  const resultView = document.getElementById('view-result');
  // ã¾ã ãƒªã‚¶ãƒ«ãƒˆç”»é¢ã§ãªã„å ´åˆï¼ˆï¼åˆå›å‘¼ã³å‡ºã—ï¼‰ã®ã¿ã€ç”»é¢åˆ‡ã‚Šæ›¿ãˆã¨æ¼”å‡ºã‚’è¡Œã†
  if (resultView.classList.contains('d-none')) {
      showView('view-result');
      // audio.playSE('correct'); // éŸ³å£°å‰Šé™¤æ¸ˆã¿ã®ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
      
      // ç´™å¹é›ªã§ãŠç¥ã„
      const end = Date.now() + 3000;
      (function frame() {
        confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
        confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
        if (Date.now() < end) requestAnimationFrame(frame);
      }());
  }
  
  document.getElementById('final-score').innerText = currentState.score;
  document.getElementById('final-combo').innerText = currentState.maxCombo;
  
  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆã“ã“ã¯æ¯å›è¡Œã†ï¼‰
  const list = document.getElementById('result-list');
  list.innerHTML = '';
  let rank = 1;
  data.participants.forEach((p, index) => {
    if (index > 0 && p.score < data.participants[index-1].score) rank = index + 1;
    
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center py-3';
    // è‡ªåˆ†ã‚’å¼·èª¿è¡¨ç¤º
    if(p.name === currentState.playerName) li.classList.add('bg-warning', 'bg-opacity-10');
    
    let icon = '';
    if(rank === 1) icon = 'ğŸ¥‡'; else if(rank === 2) icon = 'ğŸ¥ˆ'; else if(rank === 3) icon = 'ğŸ¥‰'; else icon = `<span class="badge bg-secondary rounded-pill">${rank}</span>`;
    
    li.innerHTML = `<span class="fs-5">${icon} ${p.name}</span> <span class="fw-bold fs-4">${p.score}</span>`;
    list.appendChild(li);
  });
}


/* ==========================================================================
   9. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ (Utils)
   ========================================================================== */

function stopAllIntervals() {
  if (currentState.timerInterval) clearInterval(currentState.timerInterval);
  if (currentState.syncInterval) clearInterval(currentState.syncInterval);
}

// ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ï¼ˆå³ä¸Šã®å°ã•ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
function showToast(msg, icon) { 
    Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 }).fire({ icon: icon, title: msg }); 
}

// ç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
function fireConfetti() { 
    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#FF6B6B', '#4ECDC4', '#FFE66D'] }); 
}


/* ==========================================================================
   10. æ‰‹æ›¸ããƒ¡ãƒ¢æ©Ÿèƒ½ (Handwriting Logic)
   ========================================================================== */

// ã‚­ãƒ£ãƒ³ãƒã‚¹ã®åˆæœŸåŒ–
function initCanvas() {
  const canvas = document.getElementById('handwriting-canvas');
  if(!canvas) return;
  currentState.canvas = canvas;
  currentState.ctx = canvas.getContext('2d');
  
  // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
  canvas.addEventListener('mousedown', startDrawing);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDrawing);
  canvas.addEventListener('mouseout', stopDrawing);
  // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¹ãƒãƒ›ç”¨ï¼‰
  canvas.addEventListener('touchstart', startDrawing, {passive: false});
  canvas.addEventListener('touchmove', draw, {passive: false});
  canvas.addEventListener('touchend', stopDrawing);
  
  setTimeout(resizeCanvas, 150);
}

// ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’æ ã«åˆã‚ã›ã‚‹
function resizeCanvas() {
  if (!currentState.canvas) return;
  const container = document.getElementById('drawing-container');
  if (!container || container.clientWidth === 0) return;
  
  const rect = container.getBoundingClientRect();
  if (currentState.canvas.width !== rect.width || currentState.canvas.height !== rect.height) {
      currentState.canvas.width = rect.width;
      currentState.canvas.height = rect.height;
      
      // ãƒšãƒ³ã®è¨­å®š
      currentState.ctx.strokeStyle = '#292f36'; // é»’
      currentState.ctx.lineWidth = 3;           // å¤ªã•
      currentState.ctx.lineCap = 'round';       // ä¸¸ã„ãƒšãƒ³å…ˆ
      currentState.ctx.lineJoin = 'round';
  }
}

// åº§æ¨™ã®å–å¾—ï¼ˆãƒã‚¦ã‚¹ã¨ã‚¿ãƒƒãƒã®å·®ã‚’å¸åï¼‰
function getPos(e) {
  const rect = currentState.canvas.getBoundingClientRect();
  let x, y;
  if (e.touches && e.touches.length > 0) {
    x = e.touches[0].clientX - rect.left;
    y = e.touches[0].clientY - rect.top;
  } else {
    x = e.clientX - rect.left;
    y = e.clientY - rect.top;
  }
  return {x, y};
}

function startDrawing(e) {
  if(e.target.tagName === 'BUTTON' || e.target.closest('button')) return; // ãƒœã‚¿ãƒ³æ“ä½œã¯ç„¡è¦–
  e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
  currentState.isDrawing = true;
  const pos = getPos(e);
  currentState.lastX = pos.x;
  currentState.lastY = pos.y;
}

function draw(e) {
  if (!currentState.isDrawing) return;
  e.preventDefault();
  const pos = getPos(e);
  const ctx = currentState.ctx;
  
  ctx.beginPath();
  ctx.moveTo(currentState.lastX, currentState.lastY);
  ctx.lineTo(pos.x, pos.y);
  ctx.stroke(); // ç·šã‚’æã
  
  currentState.lastX = pos.x;
  currentState.lastY = pos.y;
}

function stopDrawing() { currentState.isDrawing = false; }
function clearCanvas() { if(currentState.canvas) currentState.ctx.clearRect(0, 0, currentState.canvas.width, currentState.canvas.height); }

// ãƒ¡ãƒ¢å¸³ã®é–‹é–‰ï¼ˆã‚¹ãƒãƒ›ç”¨ï¼‰
function toggleCanvas() {
    const panel = document.getElementById('canvas-panel');
    const leftPanel = document.getElementById('left-panel');
    panel.classList.toggle('show');
    
    // è¡¨ç¤ºã•ã‚ŒãŸã‚‰ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’åˆæœŸåŒ–
    if (panel.classList.contains('show')) {
        leftPanel.classList.remove('expanded');
        setTimeout(() => { if (!currentState.canvas) initCanvas(); else resizeCanvas(); }, 300);
    } else {
        leftPanel.classList.add('expanded');
    }
}


/* ==========================================================================
   11. ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ (Keyboard Handling)
   ========================================================================== */

function handleGlobalKeydown(e) {
  // ã‚²ãƒ¼ãƒ ä¸­ä»¥å¤–ã¯ç„¡è¦–
  const gameView = document.getElementById('view-game');
  if (gameView && gameView.classList.contains('d-none')) return;

  // å…¨è§’æ•°å­—ã‚’åŠè§’ã«å¤‰æ›ã™ã‚‹ãƒãƒƒãƒ—
  const fullWidthMap = { 'ï¼':'0', 'ï¼‘':'1', 'ï¼’':'2', 'ï¼“':'3', 'ï¼”':'4', 'ï¼•':'5', 'ï¼–':'6', 'ï¼—':'7', 'ï¼˜':'8', 'ï¼™':'9', 'ï¼':'.', 'ã€‚':'.', 'ï¼':'/', 'ãƒ¼':'-', 'ï¼ˆ':'(', 'ï¼‰':')' };
  let key = e.key;
  if (fullWidthMap[key]) key = fullWidthMap[key];

  // æ•°å­—ãƒ»è¨˜å·å…¥åŠ›
  if ((key >= '0' && key <= '9') || ['.', '/', '-', '(', ')'].includes(key)) {
    inputChar(key);
    e.preventDefault();
    return;
  }
  // Enterã§æ±ºå®š
  if (key === 'Enter') {
    if (!e.isComposing) { submitAnswer(); e.preventDefault(); }
    return;
  }
  // Backspaceã§1æ–‡å­—æ¶ˆã™
  if (key === 'Backspace') { deleteNum(); e.preventDefault(); return; }
  // Escape, Delete, c ã§å…¨æ¶ˆå»
  if (key === 'Escape' || key === 'Delete' || key.toLowerCase() === 'c') { clearNum(); e.preventDefault(); return; }
}


/* ==========================================================================
   12. èµ·å‹•æ™‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
   ========================================================================== */

function doInitialize() {
  showLoading();
  // ã‚µãƒ¼ãƒãƒ¼å´ã®åˆæœŸè¨­å®šã‚’å®Ÿè¡Œ
  google.script.run.withSuccessHandler(res => {
    hideLoading();
    fireConfetti(); 
    Swal.fire({
      icon: 'success',
      title: 'æº–å‚™å®Œäº†ï¼',
      text: 'ã•ã‚ã€Qalcã‚’å§‹ã‚ã¾ã—ã‚‡ã†',
      confirmButtonColor: '#FF6B6B',
      buttonsStyling: false,
      customClass: { confirmButton: 'btn btn-pop btn-pop-primary' }
    }).then(() => {
      currentState.isInitialized = true;
      showView('view-home');
    });
  }).initialSetup();
}
</script>
